import streamlit as st
import pandas as pd
import datetime
import altair as alt
import os
import gspread
from oauth2client.service_account import ServiceAccountCredentials

st.set_page_config(page_title="ë ˆì´ì € ì‚¬ê²© ì ìˆ˜ ê¸°ë¡", layout="wide")
st.title("ğŸ¯ ë ˆì´ì €ì‚¬ê²© ì ìˆ˜ ê¸°ë¡ ì‹œìŠ¤í…œ")

# Google Sheets ì¸ì¦ ì„¤ì •
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = ServiceAccountCredentials.from_json_keyfile_name("credentials.json", scope)
client = gspread.authorize(creds)
sheet = client.open("ë ˆì´ì €ì‚¬ê²©ê¸°ë¡").sheet1

# ë°ì´í„° íŒŒì¼ ì €ì¥ ê²½ë¡œ
DATA_FILE = "laser_score_data.csv"

# ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
if os.path.exists(DATA_FILE):
    score_data = pd.read_csv(DATA_FILE, parse_dates=["ë‚ ì§œ", "ì…ë ¥ì‹œê°„"])
else:
    score_data = pd.DataFrame(columns=[
        "ë‚ ì§œ", "í•™ë…„", "ë°˜", "ë²ˆí˜¸", "ì´ë¦„",
        "1ë°œ", "2ë°œ", "3ë°œ", "4ë°œ", "5ë°œ", "í‰ê· ì ìˆ˜", "í‰ê· (50ì )", "ì…ë ¥ì‹œê°„"
    ])

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'score_data' not in st.session_state:
    st.session_state.score_data = score_data.copy()

# --- ì ìˆ˜ ì…ë ¥ í¼ ---
st.header("ğŸ“Œ íšŒê¸°ë³„ 5ë°œ ì ìˆ˜ ì…ë ¥")

with st.form("session_form"):
    col1, col2 = st.columns(2)

    with col1:
        name = st.text_input("ì´ë¦„")
        grade = st.selectbox("í•™ë…„", [f"{i}í•™ë…„" for i in range(1, 7)])
        class_name = st.selectbox("ë°˜", ["1ë°˜", "2ë°˜", "3ë°˜"])

    with col2:
        number = st.text_input("ë²ˆí˜¸")
        date = st.date_input("ë‚ ì§œ", datetime.date.today())

    st.markdown("**ğŸ’¡ í•œ íšŒê¸°ëŠ” 5ë°œì…ë‹ˆë‹¤. ì†Œìˆ˜ì  ë‹¨ìœ„ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.**")
    shot_cols = st.columns(5)
    shots = [shot_cols[i].number_input(f"{i+1}ë°œ", min_value=0.0, max_value=10.0, step=0.1, key=f"shot_{i}") for i in range(5)]

    submitted = st.form_submit_button("ì ìˆ˜ ì €ì¥")
    if submitted:
        if not name or not number:
            st.warning("ì´ë¦„ê³¼ ë²ˆí˜¸ëŠ” ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            avg = round(sum(shots) / 5, 2)
            avg_50 = round(avg * 5, 2)
            now = datetime.datetime.now()
            new_row = pd.DataFrame([[date, grade, class_name, number, name, *shots, avg, avg_50, now]],
                                   columns=st.session_state.score_data.columns)
            st.session_state.score_data = pd.concat([st.session_state.score_data, new_row], ignore_index=True)
            st.session_state.score_data.to_csv(DATA_FILE, index=False)
            # Google Sheets ì €ì¥
            sheet.append_row([
                str(date), grade, class_name, number, name,
                *shots, avg, avg_50, now.strftime('%Y-%m-%d %H:%M:%S')
            ])
            st.success(f"{grade} {class_name} {number}ë²ˆ {name} í•™ìƒì˜ ì ìˆ˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")

# --- ê¸°ë¡ í™•ì¸ & ìˆ˜ì • ---
df = st.session_state.score_data.copy()
df['ë‚ ì§œ'] = pd.to_datetime(df['ë‚ ì§œ'])
df['ì…ë ¥ì‹œê°„'] = pd.to_datetime(df['ì…ë ¥ì‹œê°„'])

if not df.empty:
    st.header("ğŸ“‹ ê¸°ë¡ í™•ì¸ ë° ìˆ˜ì •")
    st.dataframe(df.sort_values(by="ì…ë ¥ì‹œê°„", ascending=False), use_container_width=True)

    st.subheader("âœï¸ ì…ë ¥ ê¸°ë¡ ìˆ˜ì •")
    selected_index = st.selectbox("ìˆ˜ì •í•  ê¸°ë¡ ì„ íƒ", df.index, format_func=lambda i: f"{df.loc[i, 'ì´ë¦„']} ({df.loc[i, 'ë‚ ì§œ'].date()})")
    selected_row = df.loc[selected_index]

    st.markdown(f"**ì„ íƒí•œ ê¸°ë¡:** {selected_row['ì´ë¦„']} / {selected_row['ë‚ ì§œ'].date()} / {selected_row['ë²ˆí˜¸']}ë²ˆ")
    edit_cols =
